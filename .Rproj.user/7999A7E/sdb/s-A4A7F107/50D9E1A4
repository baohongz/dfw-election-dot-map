{
    "collab_server" : "",
    "contents" : "library(rgdal)\nlibrary(maptools)\nlibrary(tigris)\nlibrary(rgeos)\n\n## Read in the shape data\nvtds <- readOGR(dsn = \"data-raw\", layer = \"VTDs\", \n                stringsAsFactors = FALSE)\n\ntarrant_vtds <- vtds[vtds$CNTY == \"439\", ]\n\ndallas_vtds <- vtds[vtds$CNTY == \"113\", ]\n\ndenton_vtds <- vtds[vtds$CNTY == \"121\", ]\n\ncollin_vtds <- vtds[vtds$CNTY == \"85\", ]\n\nrockwall_vtds <- vtds[vtds$CNTY == \"397\", ]\n\n### Tarrant County\n\nsource(\"R/functions.R\")\n\ntarrant <- process_tarrant(\"data-raw/tarrant/tarrant_nov9.xlsx\")\n\n# Need to dissolve some precincts with the same name\ntarrant_vtds$CNTYVTD <- str_sub(tarrant_vtds$CNTYVTD, 1, 7)\n\ntarrant_dissolved <- gUnaryUnion(tarrant_vtds, id = tarrant_vtds$CNTYVTD)\n\n# De-dup the original data slot, then give back to the dissolved precincts\ntvtd_data <- tarrant_vtds@data %>%\n  group_by(CNTYVTD) %>%\n  filter(row_number() == 1) %>%\n  ungroup() %>%\n  as.data.frame()\n\nrow.names(tarrant_dissolved) <- as.character(1:694)\n\ntarrant_inter <- SpatialPolygonsDataFrame(tarrant_dissolved, \n                                         tvtd_data)\n\ntarrant_shape <- geo_join(tarrant_inter, tarrant, \"CNTYVTD\", \n                          \"precinct\", how = \"inner\")\n\ntarrant_dots <- votes_to_xy(tarrant_shape, 10)\n\n\n### Dallas County\n\ndallas <- process_dallas(\"data-raw/dallas/dallas_nov9.xlsx\")\n\n# Need to dissolve some precincts with the same name\ndallas_vtds$CNTYVTD <- str_sub(dallas_vtds$CNTYVTD, 1, 7)\n\ndallas_dissolved <- gUnaryUnion(dallas_vtds, id = dallas_vtds$CNTYVTD)\n\n# De-dup the original data slot, then give back to the dissolved precincts\ndvtd_data <- dallas_vtds@data %>%\n  group_by(CNTYVTD) %>%\n  filter(row_number() == 1) %>%\n  ungroup() %>%\n  as.data.frame()\n\nrow.names(dallas_dissolved) <- as.character(1:797)\n\ndallas_inter <- SpatialPolygonsDataFrame(dallas_dissolved, \n                                         dvtd_data)\n\ndallas_shape <- geo_join(dallas_inter, dallas, \"CNTYVTD\", \"precinct\", \n                          how = \"inner\")\n\ndallas_dots <- votes_to_xy(dallas_shape, 10)\n\n## Denton County\n\ndenton <- process_denton(\"data-raw/denton/denton_nov9.xlsx\")\n\ndenton_shape <- geo_join(denton_vtds, denton, \"CNTYVTD\", \"precinct\", \n                         how = \"inner\")\n\ndenton_dots <- votes_to_xy(denton_shape, 10)\n\n## Collin County\n\ncollin <- process_collin()\n\ncollin_shape <- geo_join(collin_vtds, collin, \"CNTYVTD\", \"precinct\")\n\ncollin_dots <- votes_to_xy(collin_shape, 10)\n\n## Rockwall County\n\nrockwall <- process_rockwall()\n\nrockwall_shape <- geo_join(rockwall_vtds, rockwall, \"CNTYVTD\", \"precinct\")\n\nrockwall_dots <- votes_to_xy(rockwall_shape, 10)\n\n\n## Put 'em together and export!\n\ndfw <- bind_rows(tarrant_dots, dallas_dots, denton_dots, \n                 collin_dots, rockwall_dots)\n\nwrite_csv(dfw, \"data/dfw_dots.csv\")\n\n## Generate a 1 dot = 25 as well for zoomed-out representation\n\ndot_list = list(tarrant_shape, dallas_shape, denton_shape, \n                collin_shape, rockwall_shape)\n\ndfw25 <- bind_rows(\n  lapply(dot_list, function(x) {\n    votes_to_xy(x, 25)\n  })\n)\n\nwrite_csv(dfw25, \"data/dfw_dots25.csv\")\n\n\n\n\n\n\n\n\n##############\n# Let's test some code\n##############\n\n# set.seed(1983)\n# \n# source(\"R/process_precinct_data.R\")\n# \n# tarrant <- process_data(\"data-raw/tarrant/tarrant.xlsx\", \"439\")\n# \n# tarrant$trump <- sample(50:100, nrow(tarrant), replace = TRUE)\n# \n# tarrant$clinton <- sample(50:100, nrow(tarrant), replace = TRUE)\n# \n# tarrant$johnson <- sample(10:30, nrow(tarrant), replace = TRUE)\n# \n# tarrant$stein <- sample(5:15, nrow(tarrant), replace = TRUE)\n# \n# tarrant$other <- sample(5:15, nrow(tarrant), replace = TRUE)\n# \n# ## Make some dots\n# \n# tarrant_joined <- geo_join(tarrant_vtds, tarrant, \n#                            \"CNTYVTD\", \"precinct\", how = \"inner\")\n# \n# trump_dots <- dotsInPolys(tarrant_joined, tarrant_joined$trump)\n# \n# proj4string(trump_dots) <- proj4string(tarrant_joined)\n# \n# trump_dots_xy <- spTransform(trump_dots, \n#                              CRS(\"+proj=longlat +datum=WGS84\"))\n# \n# trump_dots$longitude <- coordinates(trump_dots_xy)[,1]\n# trump_dots$latitude <- coordinates(trump_dots_xy)[,2]\n# \n# trump_out <- select(trump@data, precinct)\n# \n# ## Get a CSV-generating function\n# \n# votes_to_xy <- function(vtds, scaling_factor = 1) {\n#   \n#   values <- c(\"trump\", \"clinton\", \"johnson\", \n#               \"stein\", \"other\")\n#   \n#   xys <- bind_rows(\n#     lapply(values, function(value) {\n#       \n#       vtds[[value]] <- vtds[[value]] / scaling_factor\n#       \n#       dots <- dotsInPolys(vtds, vtds[[value]])\n#       \n#       proj4string(dots) <- proj4string(vtds)\n#       \n#       dots_xy <- spTransform(dots, CRS(\"+proj=longlat +datum=WGS84\"))\n#       \n#       dots_xy$longitude <- coordinates(dots_xy)[,1]\n#       dots_xy$latitude <- coordinates(dots_xy)[,2]\n#       \n#       dots_xy$candidate <- value\n#       \n#       return(dots_xy@data)\n#       \n#     })\n#   )\n#   \n# }\n# \n# # Test the function\n# \n# tarr_df <- votes_to_xy(tarrant_joined, 3)\n# \n# write_csv(tarr_df, \"data/test_data.csv\")\n# \n# tarr_df <- votes_to_xy(tarrant_joined, 10)\n# \n# write_csv(tarr_df, \"data/test_data_10.csv\")\n",
    "created" : 1478893713174.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1508695559",
    "id" : "50D9E1A4",
    "lastKnownWriteTime" : 1478893719,
    "last_content_update" : 1478893719398,
    "path" : "D:/Users/kylewalker/Box Sync/Center for Urban Studies/election/R/process_vtd_data.R",
    "project_path" : "R/process_vtd_data.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}